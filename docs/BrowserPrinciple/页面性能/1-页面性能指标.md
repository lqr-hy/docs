# 页面性能指标

页面性能优化的指标主要衡量用户体验和页面的加载、交互效率。这些指标有助于理解页面的性能表现，并找到优化点。以下是常用的页面性能优化指标：

### 1. **页面加载时间（Page Load Time）**

- **定义**：从用户请求页面到页面完全加载的时间。
- **目标**：尽可能短。通常，3 秒以内的页面加载时间被认为是良好的用户体验。
- **计算**：
  ```js
  const timing = performance.timing
  const loadTime = timing.loadEventEnd - timing.navigationStart
  ```

### 2. **首字节时间（Time to First Byte, TTFB）**

- **定义**：用户请求资源到接收到第一个字节的时间。
- **目标**：反映服务器响应的速度，理想情况下应小于 0.5 秒。
- **优化**：使用 CDN、缓存机制、减少服务器负载等方式来降低 TTFB。
- **计算**：
  ```javascript
  const ttfb = performance.timing.responseStart - performance.timing.navigationStart
  ```

### 3. **首屏渲染时间（First Contentful Paint, FCP）**

- **定义**：页面内容首次显示在屏幕上的时间，例如文本、图片、SVG。
- **目标**：3 秒内完成。FCP 是用户感知页面加载速度的关键指标之一。
- **优化**：减少阻塞脚本、延迟加载非关键资源、压缩图片等。
- **计算**：
  ```javascript
  const fcp = performance.getEntriesByName('first-contentful-paint')[0].startTime
  ```

### 4. **最大内容渲染时间（Largest Contentful Paint, LCP）**

- **定义**：页面最大内容元素（如大图、主标题）显示所需的时间。
- **目标**：2.5 秒以内。LCP 对用户来说是页面加载的关键进度标志。
- **优化**：优先加载首屏资源、使用 CDN、优化图片和字体的加载速度。
- **计算**：
  ```javascript
  const lcpEntry = performance.getEntriesByType('largest-contentful-paint')[0]
  const lcp = lcpEntry ? lcpEntry.startTime : 0
  ```

### 5. **首次输入延迟（First Input Delay, FID）**

- **定义**：用户首次与页面交互（如点击、滚动）到浏览器响应的时间。
- **目标**：小于 100 毫秒。FID 直接影响交互体验。
- **优化**：减少 JavaScript 执行时间，异步加载或延迟加载 JavaScript。
- **计算**：
  - 由于 FID 需要用户交互行为，可以用以下代码监听交互事件，并计算延迟：
  ```javascript
  new PerformanceObserver((entryList) => {
    const fid = entryList.getEntries()[0].processingStart - entryList.getEntries()[0].startTime
    console.log('FID:', fid)
  }).observe({ type: 'first-input', buffered: true })
  ```

### 6. **累积布局偏移（Cumulative Layout Shift, CLS）**

- **定义**：页面加载过程中元素发生位置变化的累积偏移量。
- **目标**：CLS 小于 0.1。避免内容在加载过程中跳动，提高视觉稳定性。
- **优化**：为图片和视频预留固定大小，避免动态插入内容影响布局。
- **计算**：
  ```javascript
  let cls = 0
  new PerformanceObserver((entryList) => {
    entryList.getEntries().forEach((entry) => {
      if (!entry.hadRecentInput) {
        cls += entry.value
      }
    })
  }).observe({ type: 'layout-shift', buffered: true })
  ```

### 7. **首次有意义渲染时间（First Meaningful Paint, FMP）**

- **定义**：页面主要内容首次显示的时间，通常比 FCP 稍晚。
- **目标**：3 秒以内。FMP 更注重“有意义”的内容是否尽快渲染。
- **优化**：减少阻塞渲染的脚本和样式，优先加载关键资源。

### 8. **完全可交互时间（Time to Interactive, TTI）**

- **定义**：页面完全加载并可交互的时间，用户可以无延迟地进行点击、滚动等操作。
- **目标**：5 秒以内。TTI 是用户等待页面加载完毕的重要指标。
- **优化**：拆分长任务、减少 JavaScript 解析和执行时间、使用懒加载。
- **计算**：
  ```javascript
  let tti
  new PerformanceObserver((entryList) => {
    entryList.getEntries().forEach((entry) => {
      if (entry.duration > 50) {
        // 长任务
        tti = entry.startTime + entry.duration
      }
    })
  }).observe({ type: 'longtask', buffered: true })
  ```

### 9. **请求数量（Number of Requests）**

- **定义**：页面加载时发送的总请求数。
- **目标**：尽量减少请求数。每个请求都会增加加载时间，减少不必要的资源请求可以提高性能。
- **优化**：合并 CSS/JavaScript 文件、使用 CSS Sprites、延迟加载非必要的请求。
- **计算**：
  ```javascript
  const numberOfRequests = performance.getEntriesByType('resource').length
  ```

### 10. **资源大小（Page Weight / Transfer Size）**

- **定义**：页面加载时所有资源（HTML、CSS、JavaScript、图片等）的总大小。
- **目标**：尽量减少页面总大小。一般来说，保持在 1-2 MB 以下能显著提升加载速度。
- **优化**：压缩图片、精简 CSS/JavaScript、使用 Gzip 或 Brotli 压缩。
- **计算**：
  ```javascript
  const totalSize = performance
    .getEntriesByType('resource')
    .reduce((acc, entry) => acc + entry.transferSize, 0)
  ```

### 11. **JavaScript 执行时间**

- **定义**：页面加载过程中 JavaScript 的总执行时间，包括解析和执行。
- **目标**：尽量减少 JavaScript 执行时间，减少长任务的数量。
- **优化**：使用代码分割、异步和延迟加载、减少不必要的 JavaScript 代码等。
- **计算**：
  ```javascript
  let jsExecutionTime = 0
  new PerformanceObserver((entryList) => {
    entryList.getEntries().forEach((entry) => {
      jsExecutionTime += entry.duration
    })
  }).observe({ type: 'longtask', buffered: true })
  ```

### 12. **客户端缓存命中率**

- **定义**：客户端从浏览器缓存加载资源的比例。
- **目标**：尽量提高缓存命中率，减少重复资源的请求。
- **优化**：合理设置 `Cache-Control` 和 `ETag`，缓存静态资源。
- **计算**：可以通过遍历资源请求，检查每个请求的 `transferSize` 是否为 `0`。
  ```javascript
  const cachedRequests = performance
    .getEntriesByType('resource')
    .filter((entry) => entry.transferSize === 0).length
  const cacheHitRate = (cachedRequests / numberOfRequests) * 100
  ```

### 13. **文档交互时间（DOMContentLoaded）**

- **定义**：DOM 树构建完成，JavaScript 已经可以对 DOM 进行操作的时间。
- **目标**：尽可能短。通常在 1-2 秒以内可以为用户提供快速的初始体验。
- **优化**：压缩 HTML、CSS 和 JavaScript 文件，减少非必要的 DOM 元素。
- **计算**：
  ```js
  const timing = performance.timing
  const domContentLoadedTime = timing.domContentLoadedEventEnd - timing.navigationStart
  ```

### 14. **服务端渲染（Server-Side Rendering, SSR）时间**

- **定义**：服务器将页面内容渲染成 HTML 并返回给浏览器的时间。
- **目标**：提升 SSR 的速度可以缩短 TTFB 和 FCP，提高用户的加载体验。
- **优化**：使用高效的服务端渲染框架，缓存渲染结果，减少数据库请求。

### 15. **总阻塞时间（Total Blocking Time, TBT）**

- **定义**：FCP 到 TTI 期间长任务（超过 50 毫秒）阻塞主线程的总时间。
- **目标**：尽可能低，理想情况下小于 300 毫秒。TBT 直接影响用户的交互体验。
- **优化**：分解长任务、减少 JavaScript 执行时间，使用 `requestIdleCallback` 延迟非关键任务。
- **计算**：
  ```javascript
  let tbt = 0
  new PerformanceObserver((entryList) => {
    entryList.getEntries().forEach((entry) => {
      if (entry.startTime > fcp && entry.startTime < tti) {
        tbt += entry.duration - 50
      }
    })
  }).observe({ type: 'longtask', buffered: true })
  ```

### 综合性能指标：**Core Web Vitals**

- **LCP**、**FID** 和 **CLS** 是 Google 定义的核心网页指标（Core Web Vitals），对页面的加载、交互和视觉稳定性进行量化。
- **重要性**：Google 在 SEO 排名中越来越注重页面性能，因此优化 Core Web Vitals 可以提升用户体验和 SEO 排名。

### 测试工具

- **Google Lighthouse**：检测和优化 Web Vitals 及其他页面性能指标。
- **WebPageTest**：分析页面加载的详细数据，包括时间线和资源请求信息。
- **PageSpeed Insights**：Google 提供的网页速度检测工具，提供优化建议。

### 结论

页面性能优化指标帮助开发者量化和分析页面的加载、渲染和交互性能。通过系统性优化这些指标，可以有效提升用户体验，并满足搜索引擎对于页面速度的要求。
