# 生命周期

Web Components 提供了一组生命周期回调函数，使你可以在元素的不同生命周期阶段执行特定的代码。了解和使用这些回调函数有助于创建更强大和灵活的自定义元素。

### Web Components 的生命周期回调函数

1. **`connectedCallback()`**: 当自定义元素被插入到 DOM 中时调用。这是设置事件监听器或执行需要 DOM 的初始操作的理想位置。

2. **`disconnectedCallback()`**: 当自定义元素从 DOM 中移除时调用。可以在这里移除事件监听器或执行清理操作。

3. **`attributeChangedCallback(name, oldValue, newValue)`**: 当自定义元素的属性被添加、移除或更改时调用。需要在静态方法 `observedAttributes` 中指定要观察的属性列表。

4. **`adoptedCallback()`**: 当自定义元素被移动到新的文档时调用（例如，通过 `document.adoptNode` 方法）。

### 示例代码

下面是一个使用这些生命周期回调函数的示例：

```typescript
class MyElement extends HTMLElement {
  static get observedAttributes() {
    return ['my-attr'] // 需要观察的属性
  }

  constructor() {
    super()
    this.attachShadow({ mode: 'open' })
    this.shadowRoot!.innerHTML = `
      <style>
        :host {
          display: block;
          border: 1px solid #000;
          padding: 10px;
          margin: 10px;
        }
      </style>
      <div>
        <p>Custom Element with Lifecycle Callbacks</p>
        <p>Attribute value: <span id="attrValue"></span></p>
      </div>
    `
  }

  connectedCallback() {
    console.log('Custom element added to page.')
    this.updateAttrValue()
  }

  disconnectedCallback() {
    console.log('Custom element removed from page.')
  }

  attributeChangedCallback(name: string, oldValue: string | null, newValue: string | null) {
    console.log(`Attribute ${name} changed from ${oldValue} to ${newValue}`)
    this.updateAttrValue()
  }

  adoptedCallback() {
    console.log('Custom element moved to new page.')
  }

  private updateAttrValue() {
    const attrValue = this.getAttribute('my-attr')
    this.shadowRoot!.getElementById('attrValue')!.textContent = attrValue || 'N/A'
  }
}

customElements.define('my-element', MyElement)
```

### 使用示例

在 HTML 中使用自定义元素：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Web Components Lifecycle</title>
  </head>
  <body>
    <my-element my-attr="Initial value"></my-element>

    <script type="module">
      import './my-element.js'

      const element = document.querySelector('my-element')

      // 修改属性
      setTimeout(() => {
        element.setAttribute('my-attr', 'Updated value')
      }, 2000)

      // 移除元素
      setTimeout(() => {
        element.remove()
      }, 4000)

      // 重新添加元素
      setTimeout(() => {
        document.body.appendChild(element)
      }, 6000)
    </script>
  </body>
</html>
```

### 解释代码

- **`static get observedAttributes()`**: 定义需要观察的属性列表。
- **`constructor()`**: 初始化组件，包括设置 Shadow DOM 和初始内容。
- **`connectedCallback()`**: 当元素被添加到 DOM 时调用，在这里可以执行初始化代码。
- **`disconnectedCallback()`**: 当元素从 DOM 中移除时调用，在这里可以执行清理代码。
- **`attributeChangedCallback(name, oldValue, newValue)`**: 当元素的属性发生变化时调用，在这里可以处理属性变化。
- **`adoptedCallback()`**: 当元素被移动到新文档时调用。

通过这些生命周期回调函数，可以对 Web Components 的创建、更新和销毁过程进行精细控制，确保元素在不同生命周期阶段都能正确工作。
