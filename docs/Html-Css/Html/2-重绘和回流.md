# 重绘和回流

### 1、回流（Reflow）

- **定义**：回流是指浏览器重新计算元素的几何属性（如尺寸和位置）的过程。
- **关系**：主要与 CSS 布局有关，因为布局的改变（如边距、填充、尺寸等）通常会影响元素的位置和排列。
- **触发因素**：
  - 修改 CSS 样式（如宽度、高度、边距、填充等）。
  - 添加、删除 DOM 元素。
  - 改变元素内容或可见性。
  - 改变窗口大小。

### 2、重绘（Repaint）

- **定义**：重绘是指浏览器重新渲染元素的外观，但不改变其布局的过程。
- **关系**：主要与 CSS 样式和视觉效果有关，尤其是影响颜色、背景等的样式。
- **触发因素**：
  - 修改元素的背景颜色、字体颜色等视觉属性。
  - 改变阴影效果或其他视觉样式。

:::details 常见几何属性和 DOM 树属性

1. 几何属性 (Geometry Properties)

几何属性主要指元素的尺寸、位置和形状等属性。这些属性是通过计算得出的，通常与 CSS 样式、布局和视口相关。常见的几何属性包括：

- **宽度 (`width`)**：元素的内容区域的宽度。
- **高度 (`height`)**：元素的内容区域的高度。
- **边距 (`margin`)**：元素外部的空间。
- **边框 (`border`)**：元素的边框宽度和样式。
- **填充 (`padding`)**：元素内容与边框之间的空间。
- **位置 (`offsetTop`, `offsetLeft`)**：元素相对于其最近的定位父元素的距离。
- **可见区域 (`clientWidth`, `clientHeight`)**：元素的可见宽度和高度，不包括滚动条和边框。

2. DOM 树属性 (DOM Tree Properties)

DOM 树属性是指与文档对象模型（DOM）相关的属性，这些属性描述了文档的结构和节点的关系。常见的 DOM 树属性包括：

- **`nodeName`**：节点的名称（如 `DIV`、`SPAN`）。
- **`nodeType`**：节点的类型（如元素节点、文本节点）。
- **`parentNode`**：当前节点的父节点。
- **`childNodes`**：当前节点的所有子节点。
- **`firstChild`**：当前节点的第一个子节点。
- **`lastChild`**：当前节点的最后一个子节点。
- **`nextSibling`**：当前节点的下一个兄弟节点。
- **`previousSibling`**：当前节点的上一个兄弟节点。
- **`attributes`**：节点的所有属性集合。

- **几何属性**：与元素的外观和布局相关，通常通过计算得出。
- **DOM 树属性**：与文档的结构和节点关系相关，反映了 DOM 的层次关系。

:::

总结

- **回流**：更侧重于布局（通常由 CSS 属性引起），涉及到重新计算几何属性。
- **重绘**：更侧重于视觉呈现（通常由 CSS 样式引起），涉及到重新渲染外观。

### 3、如何减少重绘和回流

#### 1. 批量修改 DOM

- **合并更改**：将多个 DOM 操作合并在一起，尽量减少操作次数。例如，使用文档片段（`DocumentFragment`）进行批量插入。

#### 2. 使用 CSS 类

- **添加和移除类**：通过改变 CSS 类来一次性修改多个样式，而不是逐个修改样式属性。

#### 3. 避免频繁访问几何属性

- **缓存几何属性**：如果需要多次访问几何属性（如 `offsetWidth`），可以先缓存值，然后再使用，避免多次触发回流。

#### 4. 使用 `requestAnimationFrame`

- **分帧更新**：将动画和视觉更新放入 `requestAnimationFrame` 中，这样可以在浏览器下一个重绘周期中进行，减少重绘和回流的次数。

#### 5. 选择合适的布局

- **使用合成层**：对一些复杂的元素（如动画元素）使用 `will-change` 或 `transform`，可以将其提升到合成层，减少回流。

#### 6. 使用 CSS 过渡和动画

- **硬件加速**：使用 CSS 过渡和动画代替 JavaScript 动画，通常更高效，且不会频繁引起回流。

#### 7. 避免使用表格布局

- **使用 Flexbox 或 Grid**：相较于表格布局，现代的布局方式（如 Flexbox 和 CSS Grid）能减少布局计算，提高性能。

#### 8. 处理复杂的样式

- **简化样式**：避免使用复杂的选择器和过多的层叠样式，简化 CSS 可以减少计算成本。
